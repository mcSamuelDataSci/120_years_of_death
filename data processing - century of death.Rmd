---
title: "Century of Death"
output: 
  html_document:
    css: "style/branding.css"
    includes:
      in_header: header_branding.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE, message=FALSE, fig.width=11, fig.align = "center")

```

```{=html}
<style type="text/css">

.main-container {
  max-width: 95% !important;
  margin-left: auto;
  margin-right: auto;
}


body { 
  font-size: 16px;
  color: black;
}

h1.title {
  font-size: 26px;
  color: DarkBlue;
  text-align: center;
  text-decoration: none;
}

h3.subtitle {
  font-size: 16px;
  color: DarkBlue;
  text-align: center;
  text-decoration: none;
}

h4.author {
  font-size: 16px;
  color: DarkBlue;
  text-align: center;
  text-decoration: none;
}

 

h1 { /* Header 1 */
  font-size: 22px;
  color: black;
  text-decoration: underline;
}


h2 {
  font-size: 22px;
  color: DarkBlue;
  margin-left: 0px;
}

h3 {
  font-size: 16px;
  font-face: bold;
  margin-left: 20px;
  color: black;
}


h4 {
  font-size: 16px;
  color: DarkBlue;
}

h5 {
  font-size: 14px;
  color: black;
}



ul {
  display: block;
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0;
  margin-left: 0;
  margin-right: 0;
  color: black;
}


body{
  font-family: Helvetica !important;
}


</style>
```

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gt)
library(forcats)
library(knitr)

# Set theme

cdph1 <- 
  theme_bw() + 
  theme(panel.grid.minor = element_blank(), 
        plot.title       = element_text(size = 16, color="darkblue"),
        axis.title       = element_text(size = 14), 
        axis.text  = element_text(size = 14)
        ) 

theme_set(cdph1)

myLineSize <- 1 

y1900 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1900") %>% mutate(year=1900)
y1910 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1910") %>% mutate(year=1910)
y1917 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1917") %>% mutate(year=1917)
y1918 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1918") %>% mutate(year=1918)
y1920 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1920") %>% mutate(year=1920)
y1929 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1929") %>% mutate(year=1929)
y1939 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1939") %>% mutate(year=1939)
y1940 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1940") %>% mutate(year=1940)
y1950 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1950") %>% mutate(year=1950)
y1960 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1960") %>% mutate(year=1960)
y1970 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1970") %>% mutate(year=1970)
y1990 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y1990") %>% mutate(year=1990)
y2000 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y2000") %>% mutate(year=2000)
y2010 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y2010") %>% mutate(year=2010)
y2018 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y2018") %>% mutate(year=2018)
y2019 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y2019") %>% mutate(year=2019)
y2020 <- read_excel("CA 1900-2020 Project.xlsx",sheet="y2020") %>% mutate(year=2020)



workDat0 <- bind_rows(y1900, y1910, y1917, y1918, y1920, y1929, y1939, y1940, y1950, y1960, y1970, y1990, y2000, y2010, y2018, y2019, y2020)



# Deaths and Population sheet
popDat <- read_excel("CA 1900-2020 Project.xlsx",sheet="Deaths and Popu.") %>%
  rename(year = 1, nDeaths = 2, population = 3, cDeathRate = 4) %>%
  select(-5)

#CCB Data Analysis
y2000ccb <- read_excel("ccb_cause_to_100_year_cause.xlsx",sheet="ccb_cause_to_100_year_causes",range="$C$1:$G$60") %>%
  rename(Number = deaths_2000) %>% 
  mutate(year=2000.2)
y2010ccb <- read_excel("ccb_cause_to_100_year_cause.xlsx",sheet="ccb_cause_to_100_year_causes")[,c(3,4,5,6,8)] %>%
  rename(Number = deaths_2010) %>% 
  mutate(year=2010.2)
y2018ccb <- read_excel("ccb_cause_to_100_year_cause.xlsx",sheet="ccb_cause_to_100_year_causes")[,c(3,4,5,6,9)] %>%
  rename(Number = deaths_2018) %>% 
  mutate(year=2018.2)



workDat1 <- bind_rows(y2000, y2000ccb, y2010, y2010ccb, y2018, y2018ccb)
```
# The 100+ years of California mortality project seeks to: 
## -Gather and standardize/sort data concerning California mortality from 1990 to present day
## -Analyze this data in order to identify patterns and create tools that will empower public health professionals to make more informed decisions.
## -Present the results of this project with useful visualizations (bar graphs, trend plots, etc.)

# Selected Findings:
## -Since 1900, causes of California mortality has shifted from communicable diseases to chronic diseases. It should be noted that communicable diseases sharply decreased until around the 1980's when HIV and drug-resistant strains emerged.
## -A significant decrease in death rates has occured (death rate in 1900 was 1,516 deaths per 100,000 individuals, whereas death rate for 2020 was 801 deaths per 100,000 persons). This decrease in death rates can be somewhat attributed to advances in medical care, but perhaps even more important are the strides made through the work of public health professionals (e.g. seatbelt laws and awareness programs, STD prevention education, better enforcment of proper hygiene/sanitation, etc.).
## -The crude death rate plots, particularly the line plots, should be interpreted carefully, as although the crude rate line plot shows that death rates for communicable disease have significantly decreased since the 1900's, a line plot of the number of deaths since 1900 reveals that though mortality from communicable disease trended downward during the early-mid 20th century, the HIV pandemic (around the 1980's) caused a surge in communicable disease mortality, as did the COVID-19 pandemic.
## -In 1900, the leading cause of death was Tuberculosis, followed by other communicable diseases (primarily communicable respiratory diseases). This is in contrast to the leading causes of death on 2020, where the leading causes of death were mostly chronic diseases (Ischemic heart disease and Alzheimer's disease), though it should be noted that COVID-19, a communicable disease, was one of the leading causes of death in 2020 (this is a departure from prior years where the leading causes of death were mainly chronic in nature).
## -The COVID-19 pandemic has provided the public with a revelation only matched by the HIV pandemic: communicable diseases are here to stay and can cause immense death, morbidity, and economic damage.


```{r fig.height= 8, fig.width= 15}
workGroup1a <- workDat0 %>% 
               group_by(year, topLevel, troubleshooting, specificLevel)     %>% 
               summarise(deaths=sum(Number)) %>%
  left_join(select(popDat, year, population), by = "year") %>%
  mutate(cDeathRate = 100000*deaths/population)

workGroup1b <- workGroup1a  %>%
  select(-population, -cDeathRate) %>%
               pivot_wider(names_from = year, values_from = deaths)  

# Number of Deaths Plot (specificLevel) - INCLUDE THIS CHART

ggplot(workGroup1a, aes(x=fct_rev(specificLevel), y=deaths, fill = topLevel)) +
  theme(axis.text.x = element_text(size=10, angle=90, hjust=0.5), axis.text.y = element_text(size=13), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  geom_col() +
  coord_flip() +
  labs(title = "Number of Deaths as Sorted by specificLevel",
       y = "Number of Deaths", x = "Cause of Death") +
  facet_wrap(vars(year),nrow=1,scales = "free_x") +
theme(plot.title = element_text(hjust = 0.5, size=30))

# Number of Deaths Plot (troubleshooting)

ggplot(workGroup1a, aes(x=fct_rev(troubleshooting), y=deaths, fill = topLevel)) +
  theme(axis.text.x = element_text(size=10, angle=90, hjust=0.5), axis.text.y = element_text(size=13), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  geom_col() +
  coord_flip() +
  labs(title = "Troubleshooting Deaths (Alternative to specificLevel)",
       y = "Number of Deaths", x = "Cause of Death") +
  facet_wrap(vars(year),nrow=1,scales = "free_x") +
theme(plot.title = element_text(hjust = 0.5, size=30))

# Crude Death Rates (specificLevel)

ggplot(workGroup1a, aes(x=fct_rev(specificLevel), y=cDeathRate, fill = topLevel)) +
  theme(axis.text.x = element_text(size=10, angle=90, hjust=0.5), axis.text.y = element_text(size=13), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  geom_col() +
  coord_flip() +
  labs(title = "Crude Death Rates (specificLevel)",
       y = "Crude Death Rate per 100k Pop", x = "Cause of Death") +
  facet_wrap(vars(year),nrow=1) +
  theme(plot.title = element_text(hjust = 0.5, size=30))

# Crude Death Rates (topLevel)

ggplot(workGroup1a, aes(x=year, y=cDeathRate, fill = topLevel)) +
  theme(axis.text.x = element_text(size=20, hjust=0.5), axis.text.y = element_text(size=20), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  geom_col(width = 0.9) +
  #coord_flip() +
  labs(title = "Crude Death Rates (topLevel)",
       y = "Crude Death Rate per 100k Pop", x = "Cause of Death") +
  theme(plot.title = element_text(hjust = 0.5, size=30))


```

<br>
<hr>


```{r fig.height= 8, fig.width= 12}
workGroup1c <- workDat1 %>% 
               group_by(year, topLevel, troubleshooting, specificLevel)     %>% 
               summarise(deaths=sum(Number)) %>%
  left_join(select(popDat, year, population), by = "year") %>%
  mutate(cDeathRate = 100000*deaths/population)

#CCB vs. CDC Specific Level (Graph)

ggplot(workGroup1c, aes(x=fct_rev(specificLevel), y=deaths, fill = topLevel)) +
  theme(axis.text.x = element_text(size=13, angle=90, hjust=0.5), axis.text.y = element_text(size=13), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  geom_col() +
  coord_flip() +
  labs(title = "Number of Deaths as Sorted by specificLevel",
       y = "Number of Deaths", x = "Cause of Death") +
  facet_wrap(vars(year),nrow=1) +
theme(plot.title = element_text(hjust = 0.5, size=25))

#CCB vs. CDC Specific Level (Table)

library(formattable)

customGreen0 = "#DeF7E9"
customGreen = "#71CA97"

workGroup1d <- workDat1  %>%
               group_by(year, specificLevel)     %>% 
               summarise(deaths=sum(Number)) %>%
  left_join(select(popDat, year, population), by = "year") %>%
  mutate(cDeathRate = 100000*deaths/population) %>%
  select(-population, -cDeathRate) %>%
               pivot_wider(names_from = year, values_from = deaths)

names(workGroup1d) <- c("specificLevel", "CDC2000", "CCB2000", "CDC2010", "CCB2010", "CDC2018", "CCB2018")

workGroup1d <- workGroup1d %>% mutate(DIF2000 = CDC2000-CCB2000)
workGroup1d <- workGroup1d %>% mutate(DIF2010 = CDC2010-CCB2010)
workGroup1d <- workGroup1d %>% mutate(DIF2018 = CDC2018-CCB2018)

formattable(workGroup1d,
            align =c("l","c","c","c","c", "c", "c"),
            list(`specificLevel` = formatter("span", style = ~ style(font.weight = "bold")),
                 'DIF2000'= color_tile(customGreen, customGreen0),
                 'DIF2010'= color_tile(customGreen, customGreen0),
                 'DIF2018'= color_tile(customGreen, customGreen0)
))

```
<br>
<hr>


```{r fig.height= 8, fig.width= 12}

workGroup3 <- workDat0 %>% group_by(year, topLevel)  %>% 
               summarise(deaths=sum(Number)) %>%
  left_join(select(popDat, year, population), by = "year") %>%
  mutate(cDeathRate = 100000*deaths/population)


# Number of Deaths Plot
ggplot(workGroup3, aes(x=year, y=deaths, color=topLevel)) +
  theme(axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  geom_line(size=2) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  labs(title = "Number of Deaths (topLevel Line Plot)",
       y = "Deaths", x = "Year") +
theme(plot.title = element_text(hjust = 0.5, size=25))

# Crude Death Rate Plot - INCLUDE THIS CHART

ggplot(workGroup3, aes(x=year, y=cDeathRate, color=topLevel)) +
 theme(axis.text.x = element_text(size=15), axis.text.y = element_text(size=15), axis.title.x = element_text(size=22), axis.title.y = element_text(size=22)) +
  geom_line(size=2) +
  theme(legend.key.size = unit(1, 'cm'), 
        legend.key.height = unit(1, 'cm'), 
        legend.key.width = unit(1, 'cm'), 
        legend.title = element_text(size=17), 
        legend.text = element_text(size=13)) +
  labs(title = "Crude Death Rate per 100,000 (topLevel Line Plot)",
       y = "Deaths per 100,000", x = "Year") +
theme(plot.title = element_text(hjust = 0.5, size=25))


```

<br>
<hr>

```{r}

#yNformat <- fmt_number(columns = 4:13, use_seps = TRUE, decimals = 0) 

workGroup1b %>% gt()  %>%
  tab_options(table.font.size = 9) %>%
  tab_style(
    style = list(cell_fill(color = "lightcyan"),
                 cell_text(weight = "bold")  ),
    locations =  cells_row_groups()    ) %>%
    fmt_number(columns = 4:12, use_seps = TRUE, decimals = 0) %>%
  summary_rows(columns= 4:12, fns = list(sum = ~sum(.,na.rm = TRUE)), formatter = fmt_number)
  


# https://stackoverflow.com/questions/66018397/how-to-specify-a-custom-formatter-function-gt-table-grand-summary



```





```{r}
#library(gitcreds)
#gitcreds_set()


```

